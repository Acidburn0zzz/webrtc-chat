(function(){$(document).ready(function(){var a,b,c,d,e,f,g,h,i,j,k,l;h={login:document.querySelector("#page-login"),caller:document.querySelector("#page-caller")};for(g in h)h[g].className+=" page";return h.login.className+=" active",window.pubnub=null,l=null,e=null,document.querySelector("#login").addEventListener("click",function(){return l=document.querySelector("#userid").value,window.pubnub=PUBNUB.init({publish_key:"pub-c-7070d569-77ab-48d3-97ca-c0c3f7ab6403",subscribe_key:"sub-c-49a2a468-ced1-11e2-a5be-02ee2ddab7fe",uuid:l}),pubnub.onNewConnection(function(a){return e?i(a):void 0}),h.login.className=h.login.className.replace("active",""),h.caller.className+=" active",$(document).trigger("pubnub:ready")}),k=_.template($("#user-item-template").text()),j=$("#user-list"),$(document).on("pubnub:ready",function(){return pubnub.subscribe({channel:"phonebook",callback:function(){},presence:function(a){var b,c;return"join"===a.action&&a.uuid!==l?(c=k({name:a.uuid}),j.append(c)):"leave"===a.action&&a.uuid!==l?(b=j.find('li[data-user="'+a.uuid+'"]'),b.remove()):void 0}})}),b="",d=$("#answer-modal"),d.modal({show:!1}),i=function(a){return console.log("Publishing Stream!!!",a),pubnub.publish({user:a,stream:e}),pubnub.subscribe({user:a,stream:function(a,b){return console.log("Got stream:",b),document.querySelector("#call-video").src=URL.createObjectURL(b.stream)}})},a=function(a){return i(a),pubnub.publish({channel:"answer",message:{caller:b,callee:l}})},$(document).on("pubnub:ready",function(){return pubnub.subscribe({channel:"call",callback:function(a){return a.callee===l?(b=a.caller,f(a.caller)):void 0}}),pubnub.subscribe({channel:"answer",callback:function(a){return a.caller===l?i(a.callee):void 0}})}),f=function(a){return d.find(".caller").text(""+a+" is calling..."),d.modal("show")},d.find(".btn-primary").on("click",function(){return a(b),d.modal("hide")}),$("#user-list").on("click","a[data-user]",function(a){var b;return b=$(a.target).data("user"),console.log("Calling",b),pubnub.publish({channel:"call",message:{caller:l,callee:b}})}),c=function(a){return document.querySelector("#self-call-video").src=URL.createObjectURL(a),e=a},navigator.webkitGetUserMedia({audio:!1,video:!0},c)})}).call(this);