(function(){$(document).ready(function(){var a,b,c,d,e,f,g,h,i,j,k,l;return h={login:document.querySelector("#page-login"),caller:document.querySelector("#page-caller")},h.login.className+=" active",window.pubnub=null,l=null,c=null,f=null,document.querySelector("#login").addEventListener("click",function(){return l=document.querySelector("#userid").value,window.pubnub=PUBNUB.init({publish_key:"pub-c-7070d569-77ab-48d3-97ca-c0c3f7ab6403",subscribe_key:"sub-c-49a2a468-ced1-11e2-a5be-02ee2ddab7fe",uuid:l}),pubnub.onNewConnection(function(a){return f?i(a):void 0}),h.login.className=h.login.className.replace("active",""),h.caller.className+=" active",$(document).trigger("pubnub:ready")}),k=_.template($("#user-item-template").text()),j=$("#user-list"),$(document).on("pubnub:ready",function(){return pubnub.subscribe({channel:"phonebook",callback:function(){},presence:function(a){var b,c;return"join"===a.action&&a.uuid!==l?(c=k({name:a.uuid}),j.append(c)):"leave"===a.action&&a.uuid!==l?(b=j.find('li[data-user="'+a.uuid+'"]'),b.remove()):void 0}})}),b="",e=$("#answer-modal"),e.modal({show:!1}),i=function(a){return pubnub.publish({user:a,stream:f}),pubnub.subscribe({user:a,stream:function(a,b){return console.log("Got stream:",b),document.querySelector("#call-video").src=URL.createObjectURL(b.stream)}})},a=function(a){return i(a),pubnub.publish({channel:"answer",message:{caller:b,callee:l}})},$(document).on("pubnub:ready",function(){return pubnub.subscribe({channel:"call",callback:function(a){return a.callee===l?(b=a.caller,g(a.caller)):void 0}}),pubnub.subscribe({channel:"answer",callback:function(a){return a.caller===l?(c=a.callee,i(a.callee)):void 0}})}),g=function(a){return e.find(".caller").text(""+a+" is calling..."),e.modal("show")},e.find(".btn-primary").on("click",function(){return a(b),e.modal("hide")}),$("#user-list").on("click","a[data-user]",function(a){var b;return b=$(a.target).data("user"),c=b,pubnub.publish({channel:"call",message:{caller:l,callee:b}})}),$("#hang-up").on("click",function(){return pubnub.peerConnection(c,function(a){return a.close()})}),d=function(a){return document.querySelector("#self-call-video").src=URL.createObjectURL(a),f=a},navigator.webkitGetUserMedia({audio:!1,video:!0},d)})}).call(this);